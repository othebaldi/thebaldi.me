<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto ESESP - ENGECON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900">
    <div class="fixed inset-0 bg-cover bg-center" style="background-image: url('assets/fundo-login.jpg');"></div>
    <div class="fixed inset-0 bg-black/60"></div>
    
    <div class="relative min-h-screen flex flex-col items-center justify-center text-white text-center p-4">
        <img src="assets/logo-engecon.png" alt="Logo Engecon" class="h-16 mb-6 animate-pulse">
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">PROJETO ESESP</h1>
        <p class="mt-2 text-lg max-w-2xl">Projeto de Urbanismo, Paisagismo e Sinalização do Estacionamento</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "...", authDomain: "...", projectId: "..." };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        function navigateTo(page) {
            // Corrigido: usando pathname para navegação relativa no ambiente de preview.
            window.location.pathname = page;
        }

        async function checkUserStatus() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            const isAuthenticated = sessionStorage.getItem('isAuthenticated') === 'true';
            const loggedUserEmail = sessionStorage.getItem('loggedInUser');

            if (isAuthenticated && loggedUserEmail) {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, loggedUserEmail);
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().isFirstLogin) {
                        navigateTo('change-password.html');
                    } else {
                        navigateTo('portfolio.html');
                    }
                } catch (error) {
                    console.error("Error checking user status: ", error);
                    navigateTo('login.html');
                }
            } else {
                navigateTo('login.html');
            }
        }

        setTimeout(checkUserStatus, 1500);
    </script>
</body>
</html>

